<!DOCTYPE html>
<html>
<head>
    <title><?= $title ?? 'Inventory Management' ?></title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; margin: 0; padding: 0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .header-left { }
        .header-right { }
        .header h1 { margin: 0; font-size: 2rem; }
        .btn { padding: 10px 20px; border-radius: 4px; text-decoration: none; font-weight: bold; border: none; cursor: pointer; display: inline-block; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-sm { padding: 5px 10px; font-size: 0.875rem; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-secondary { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); }
        .btn-secondary:hover { background: rgba(255,255,255,0.3); }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .alert { padding: 15px; border-radius: 4px; margin-bottom: 20px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .table-responsive { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 15px; text-align: left; font-weight: 600; border-bottom: 2px solid #dee2e6; }
        td { padding: 12px 15px; border-bottom: 1px solid #dee2e6; }
        tr:hover { background: #f9f9f9; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: bold; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .table-container { margin-top: 20px; }
        .no-products { text-align: center; padding: 40px; color: #999; }
        
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 8px; width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; }
        .modal-header h2 { margin: 0; color: #333; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #666; }
        .modal-close:hover { color: #333; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; color: #333; margin-bottom: 8px; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 5px rgba(102, 126, 234, 0.3); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .modal-footer { display: flex; gap: 10px; margin-top: 25px; padding-top: 15px; border-top: 1px solid #f0f0f0; }
        .modal-footer button { flex: 1; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-submit { background: #28a745; color: white; }
        .btn-submit:hover { background: #218838; }
        .btn-cancel { background: #6c757d; color: white; }
        .btn-cancel:hover { background: #5a6268; }
        
        /* View Modal */
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0; }
        .info-item { background: #f8f9fa; padding: 12px; border-radius: 4px; border-left: 3px solid #667eea; }
        .info-label { font-size: 0.85rem; color: #666; text-transform: uppercase; }
        .info-value { font-size: 1rem; font-weight: bold; color: #333; margin-top: 5px; }
        @media (max-width: 768px) { .form-row { grid-template-columns: 1fr; } .info-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="header-left">
            <a href="/odoo/dashboard" class="btn btn-secondary">‚Üê Kembali ke Dashboard</a>
        </div>
        <div class="header-right">
            <button onclick="openAddModal()" class="btn btn-primary">+ Tambah Produk</button>
        </div>
    </div>

    <?php if ($this->flashSession->has('success')): ?>
        <div class="alert alert-success">
            <?php echo $this->flashSession->output(); ?>
        </div>
    <?php endif; ?>

    <?php if ($this->flashSession->has('error')): ?>
        <div class="alert alert-danger">
            <?php echo $this->flashSession->output(); ?>
        </div>
    <?php endif; ?>

    <?php if (empty($products)): ?>
        <div class="table-responsive">
            <div class="no-products">
                <p>Belum ada produk. <button onclick="openAddModal()" class="btn btn-primary">Tambah Produk</button></p>
            </div>
        </div>
    <?php else: ?>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nama</th>
                        <th>SKU</th>
                        <th>Kategori</th>
                        <th>Stok</th>
                        <th>Harga</th>
                        <th>Tipe</th>
                        <th>Status</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($products as $product): ?>
                        <tr>
                            <td><?= $product->id ?></td>
                            <td><strong><?= htmlspecialchars($product->name) ?></strong></td>
                            <td><?= htmlspecialchars($product->sku ?? '-') ?></td>
                            <td><?= htmlspecialchars($product->category ?? '-') ?></td>
                            <td>
                                <span class="badge <?= $product->quantity > 0 ? 'badge-success' : 'badge-danger' ?>">
                                    <?= $product->quantity ?>
                                </span>
                            </td>
                            <td>Rp <?= number_format($product->selling_price, 0, ',', '.') ?></td>
                            <td><?= htmlspecialchars($product->product_type) ?></td>
                            <td>
                                <span class="badge <?= $product->synced_to_odoo ? 'badge-success' : 'badge-warning' ?>">
                                    <?= $product->synced_to_odoo ? '‚úì Synced' : '‚úó Not Synced' ?>
                                </span>
                            </td>
                            <td>
                                <div class="actions">
                                    <button onclick='openViewModal(<?= json_encode($product->toArray()) ?>)' class="btn btn-primary btn-sm">View</button>
                                    <button onclick='openEditModal(<?= json_encode($product->toArray()) ?>)' class="btn btn-warning btn-sm">Edit</button>
                                    <button onclick="deleteProduct(<?= $product->id ?>)" class="btn btn-danger btn-sm">Delete</button>
                                </div>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        </div>
    <?php endif; ?>
</div>

<!-- Modal: Add Product -->
<div id="addModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>‚ûï Tambah Produk</h2>
            <button class="modal-close" onclick="closeAddModal()">√ó</button>
        </div>
        <form onsubmit="submitAdd(event)" method="POST">
            <div class="form-group">
                <label>Nama Produk *</label>
                <input type="text" name="name" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>SKU</label>
                    <input type="text" name="sku">
                </div>
                <div class="form-group">
                    <label>Kategori *</label>
                    <select name="category" required>
                        <option value="">- Pilih Kategori -</option>
                        <?php foreach ($categories as $cat): ?>
                            <option value="<?= $cat->name ?>"><?= $cat->name ?></option>
                        <?php endforeach; ?>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Harga Jual *</label>
                    <input type="number" name="selling_price" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Harga Pokok</label>
                    <input type="number" name="cost_price" step="0.01" min="0">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Stok Awal</label>
                    <input type="number" name="quantity" min="0" value="1">
                </div>
                <div class="form-group">
                    <label>Tipe Produk</label>
                    <select name="product_type">
                        <option value="consu">Consumable</option>
                        <option value="product">Product</option>
                        <option value="service">Service</option>
                        <option value="combo">Combo</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Deskripsi</label>
                <textarea name="description" rows="3"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-cancel" onclick="closeAddModal()">Batal</button>
                <button type="submit" class="btn btn-submit">Simpan</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal: Edit Product -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>‚úèÔ∏è Edit Produk & Stok</h2>
            <button class="modal-close" onclick="closeEditModal()">√ó</button>
        </div>
        <form onsubmit="submitEdit(event)" method="POST">
            <input type="hidden" id="editId" name="id">
            <div class="form-group">
                <label>Nama Produk *</label>
                <input type="text" id="editName" name="name" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>SKU</label>
                    <input type="text" id="editCode" name="sku">
                </div>
                <div class="form-group">
                    <label>Kategori *</label>
                    <select id="editCategory" name="category" required>
                        <option value="">- Pilih Kategori -</option>
                        <?php foreach ($categories as $cat): ?>
                            <option value="<?= $cat->name ?>"><?= $cat->name ?></option>
                        <?php endforeach; ?>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Harga Jual *</label>
                    <input type="number" id="editPrice" name="selling_price" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Harga Pokok</label>
                    <input type="number" id="editCost" name="cost_price" step="0.01" min="0">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>üìä Stok Saat Ini</label>
                    <input type="number" id="editQuantity" name="quantity" min="0" required>
                </div>
                <div class="form-group">
                    <label>Tipe Produk</label>
                    <select id="editType" name="product_type">
                        <option value="consu">Consumable</option>
                        <option value="product">Product</option>
                        <option value="service">Service</option>
                        <option value="combo">Combo</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Deskripsi</label>
                <textarea id="editDescription" name="description" rows="3"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-cancel" onclick="closeEditModal()">Batal</button>
                <button type="submit" class="btn btn-submit">Simpan</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal: View Product -->
<div id="viewModal" class="modal">
    <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header">
            <h2 id="viewTitle" style="font-size: 1.3rem;">Detail Produk</h2>
            <button class="modal-close" onclick="closeViewModal()">√ó</button>
        </div>
        <div id="viewContent" style="padding: 15px 0;"></div>
    </div>
</div>

<script>
function openAddModal() {
    document.getElementById('addModal').classList.add('show');
}

function closeAddModal() {
    document.getElementById('addModal').classList.remove('show');
    document.getElementById('addModal').querySelector('form').reset();
}

function openEditModal(product) {
    document.getElementById('editId').value = product.id;
    document.getElementById('editName').value = product.name;
    document.getElementById('editCode').value = product.sku || '';
    document.getElementById('editCategory').value = product.category || '';
    document.getElementById('editPrice').value = product.selling_price || 0;
    document.getElementById('editCost').value = product.cost_price || 0;
    document.getElementById('editQuantity').value = product.quantity || 0;
    document.getElementById('editType').value = product.product_type || '';
    document.getElementById('editDescription').value = product.description || '';
    document.getElementById('editModal').classList.add('show');
}

function closeEditModal() {
    document.getElementById('editModal').classList.remove('show');
}

function openViewModal(product) {
    const stock_color = product.quantity > 0 ? '#28a745' : '#dc3545';
    const stock_text = product.quantity > 0 ? 'Available' : 'Out of Stock';
    document.getElementById('viewTitle').innerHTML = 'üëÅÔ∏è ' + (product.name || 'Produk');
    let html = `
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">SKU</div>
                <div class="info-value">${product.sku || '-'}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Kategori</div>
                <div class="info-value">${product.category || '-'}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Stok</div>
                <div class="info-value" style="color: ${stock_color}">${product.quantity || 0} unit</div>
            </div>
            <div class="info-item">
                <div class="info-label">Tipe</div>
                <div class="info-value">${product.product_type || '-'}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Harga Jual</div>
                <div class="info-value">Rp ${new Intl.NumberFormat('id-ID').format(product.selling_price || 0)}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Harga Pokok</div>
                <div class="info-value">Rp ${new Intl.NumberFormat('id-ID').format(product.cost_price || 0)}</div>
            </div>
        </div>
        ${product.description ? `<div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 15px 0; border-left: 3px solid #667eea;"><strong style="color: #667eea;">Deskripsi:</strong><p style="margin: 8px 0 0 0; white-space: pre-wrap; color: #555;">${product.description}</p></div>` : ''}
        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #f0f0f0; text-align: right;">
            <button onclick="closeViewModal()" class="btn btn-primary btn-sm">Tutup</button>
        </div>
    `;
    document.getElementById('viewContent').innerHTML = html;
    document.getElementById('viewModal').classList.add('show');
}

function closeViewModal() {
    document.getElementById('viewModal').classList.remove('show');
}

function submitAdd(e) {
    e.preventDefault();
    const form = e.target;
    const params = new URLSearchParams();
    new FormData(form).forEach((v,k) => params.append(k, v));

    fetch('/api.php?action=create_inventory', { 
        method: 'POST', 
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: params.toString()
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            closeAddModal();
            window.location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(e => {
        alert('Error: ' + e.message);
    });
}

function submitEdit(e) {
    e.preventDefault();
    const id = document.getElementById('editId').value;
    const params = new URLSearchParams();
    new FormData(e.target).forEach((v,k) => params.append(k, v));

    // Send to stable public API endpoint to ensure JSON response
    fetch('/api.php?action=edit_inventory', { 
        method: 'POST', 
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: params.toString() + '&id=' + encodeURIComponent(id)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            closeEditModal();
            window.location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(e => {
        alert('Error: ' + e.message);
    });
}

function deleteProduct(id) {
    if (confirm('Yakin hapus produk ini?')) {
        fetch('/odoo-inventory/delete/' + id, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(e => alert('Error: ' + e.message));
    }
}

// Close modal when clicking outside
window.onclick = function(e) {
    const addModal = document.getElementById('addModal');
    const editModal = document.getElementById('editModal');
    const viewModal = document.getElementById('viewModal');
    if (e.target === addModal) closeAddModal();
    if (e.target === editModal) closeEditModal();
    if (e.target === viewModal) closeViewModal();
}
</script>
</body>
</html>
