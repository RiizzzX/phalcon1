<?= $this->getContent() ?>

<div class="container" style="padding: 40px 20px;">
    <div style="margin-bottom: 20px;">
        <a href="/odoo-dashboard" style="color: #3498db; text-decoration: none;">üìä Dashboard</a> / 
        <a href="/odoo-invoicing" style="color: #3498db; text-decoration: none;">Invoicing</a> / 
        <span style="color: #7f8c8d;">Buat Invoice</span>
    </div>
    
    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px;">
        <h1 style="margin: 0 0 10px 0;">üí∞ <?= $title ?></h1>
        <p style="margin: 0; opacity: 0.9;">Buat invoice untuk customer</p>
    </div>

    <form method="post" style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 800px;">
        <h3 style="margin: 0 0 20px 0; color: #2c3e50;">üë§ Customer</h3>
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">Pilih Customer *</label>
            <select id="partnerSelect" name="partner_id" required style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px;">
                <option value="">-- Pilih Customer --</option>
                <?php if (isset($customers) && !empty($customers)): ?>
                    <?php foreach ($customers as $customer): ?>
                        <option value="<?= $customer['id'] ?>"><?= htmlspecialchars($customer['name']) ?></option>
                    <?php endforeach; ?>
                <?php endif; ?>
            </select>
        </div>
        
        <hr style="margin: 30px 0; border: none; border-top: 2px solid #ecf0f1;">
        <h3 style="margin: 0 0 20px 0; color: #2c3e50;">üì¶ Produk</h3>
        
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">Pilih Produk *</label>
            <select name="product_id" id="productSelect" required onchange="updateProductInfo()" style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px;">
                <option value="">-- Pilih Produk --</option>
                <?php if (isset($products) && !empty($products)): ?>
                    <?php foreach ($products as $product): ?>
                        <option value="<?= $product['id'] ?>" 
                                data-name="<?= htmlspecialchars($product['name']) ?>"
                                data-price="<?= $product['list_price'] ?? 0 ?>"
                                data-code="<?= htmlspecialchars($product['default_code'] ?? '') ?>">
                            <?= htmlspecialchars($product['name']) ?>
                            <?php if (isset($product['default_code'])): ?>
                                [<?= htmlspecialchars($product['default_code']) ?>]
                            <?php endif; ?>
                        </option>
                    <?php endforeach; ?>
                <?php endif; ?>
            </select>
        </div>
        
        <div id="productInfo" style="display: none; background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); padding: 15px; border-radius: 8px; margin: 15px 0;">
            <strong>Informasi Produk:</strong>
            <div style="margin-top: 10px;">
                <div>Nama: <span id="infoName">-</span></div>
                <div>Kode: <span id="infoCode">-</span></div>
                <div>Harga: Rp <span id="infoPrice">0</span></div>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">Quantity *</label>
                <input type="number" name="quantity" id="quantity" value="1" min="1" required onchange="calculateTotal()" onkeyup="calculateTotal()" style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px;">
            </div>
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">Harga Per Unit *</label>
                <input type="number" name="price" id="price" value="0" min="0" step="0.01" required onchange="calculateTotal()" onkeyup="calculateTotal()" style="width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px;">
            </div>
        </div>
        
        <input type="hidden" name="product_name" id="product_name_hidden">
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0; text-align: center;">
            <div style="color: #7f8c8d; font-size: 14px; margin-bottom: 5px;">Total Amount</div>
            <div style="font-size: 24px; font-weight: 700; color: #2c3e50;">
                Rp <span id="totalAmount">0</span>
            </div>
        </div>

        <div style="display:flex; align-items:center; gap:12px; margin-top:18px;">
            <label style="display:inline-flex; align-items:center; gap:8px; margin-right:auto; color:#2c3e50;"><input type="checkbox" name="post_now" id="post_now" checked> Post invoice sekarang</label>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 8px;">
            <button type="submit" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: 600;">
                ‚úÖ Buat Invoice
            </button>
            <a href="/odoo-invoicing" style="flex: 1; padding: 12px; background: #6c757d; color: white; text-decoration: none; border-radius: 8px; text-align: center; display: block;">
                ‚Üê Batal
            </a>
        </div>
    </form>
</div>

<script>
function updateProductInfo() {
    const select = document.getElementById('productSelect');
    const option = select.options[select.selectedIndex];
    const productInfo = document.getElementById('productInfo');
    
    if (option.value) {
        const name = option.dataset.name || '-';
        const code = option.dataset.code || '-';
        const price = parseFloat(option.dataset.price) || 0;
        
        document.getElementById('infoName').textContent = name;
        document.getElementById('infoCode').textContent = code;
        document.getElementById('infoPrice').textContent = price.toLocaleString('id-ID');
        document.getElementById('price').value = price;
        document.getElementById('product_name_hidden').value = name;
        
        productInfo.style.display = 'block';
        calculateTotal();
    } else {
        productInfo.style.display = 'none';
        document.getElementById('product_name_hidden').value = '';
    }
}

function calculateTotal() {
    const quantity = parseFloat(document.getElementById('quantity').value) || 0;
    const price = parseFloat(document.getElementById('price').value) || 0;
    const total = quantity * price;
    
    document.getElementById('totalAmount').textContent = total.toLocaleString('id-ID');
}

// Preselect partner if provided via query param
(function(){
    try {
        const params = new URLSearchParams(window.location.search);
        const pid = params.get('partner_id');
        if (pid) {
            const sel = document.getElementById('partnerSelect');
            if (sel) {
                // if numeric, set directly; otherwise ignore
                if (/^\d+$/.test(pid)) sel.value = pid;
                else {
                    // if local-<id>, attempt to create partner in Odoo then preselect
                    if (/^local-\d+$/.test(pid)) {
                        // fetch the partner details from list_partners and create in Odoo
                        fetch('/api.php?action=list_partners').then(r=>r.json()).then(data=>{
                            if (data && data.success) {
                                const p = (data.data||[]).find(x => String(x.id) === pid);
                                if (p) {
                                    fetch('/api.php?action=create_partner',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:p.name,email:p.email,phone:p.phone,save_to:'odoo'})}).then(rr=>rr.json()).then(resp=>{
                                        if (resp && resp.partner_id) sel.value = resp.partner_id;
                                    });
                                }
                            }
                        });
                    }
                }
            }
        }
    } catch (e) { console.error(e); }
})();
</script>
