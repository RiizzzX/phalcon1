<?= $this->getContent() ?>

<style>
    .cust-table th { background: #f5f7fa; padding: 12px; text-align: left; }
    .cust-table td { padding: 10px; border-bottom: 1px solid #eef0f2; }
    .cust-row:hover { background: #fbfcfd; }
    .btn-small { padding: 8px 12px; font-size: 13px; border-radius:6px; }
    #searchCustomers { border:1px solid #dce4ea; box-shadow: inset 0 1px 0 rgba(255,255,255,0.6); }
    .badge-local { background:#f0f0f0; color:#333; padding:5px 8px; border-radius:6px; }
</style>

<div class="container" style="padding: 40px 20px;">
    <div style="margin-bottom: 20px;">
        <a href="/odoo-dashboard" style="color: #3498db; text-decoration: none;">üìä Dashboard</a> / 
        <span style="color: #7f8c8d;">üë• Kelola Customers</span>
    </div>

    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
        <h1 style="margin: 0;">üë• Kelola Customers</h1>
        <p style="margin: 0; opacity: 0.9;">Lihat, cari, dan hapus customer (Odoo + Lokal)</p>
    </div>

    <div style="margin-bottom: 12px; display:flex; gap:8px; align-items:center;">
        <button id="btnBulkDelete" class="btn btn-danger" style="display: none; padding: 10px 15px; border-radius: 6px; font-weight: bold;">üóëÔ∏è Hapus Terpilih (0)</button>
        <input id="searchCustomers" placeholder="Cari name/email/phone" style="flex:1; padding:10px; border-radius:6px; border:1px solid #ddd;">
        <button id="btnSearch" class="btn btn-primary">Cari</button>
        <button id="btnRefresh" class="btn btn-primary">üîÑ Refresh</button>
        <a href="/odoo-sales" class="btn btn-secondary">‚Üê Kembali ke Sales</a>
    </div>

    <div id="custAlert"></div>

    <div style="background: white; padding: 12px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.06);">
        <table style="width:100%; border-collapse:collapse;">
            <thead>
                <tr style="background:#f5f7fa; text-align:left;">
                    <th style="padding:10px; width:40px;"><input type="checkbox" id="selectAll"></th>
                    <th style="padding:10px;">ID</th>
                    <th style="padding:10px;">Nama</th>
                    <th style="padding:10px;">Email</th>
                    <th style="padding:10px;">Telepon</th>
                    <th style="padding:10px;">Sumber</th>
                    <th style="padding:10px; text-align:center;">Aksi</th>
                </tr>
            </thead>
            <tbody id="customersBody"></tbody>
        </table>
    </div>
</div>

<script>
const api = '/api.php';
function showCustAlert(msg, type='info'){
    const c = document.getElementById('custAlert');
    c.innerHTML = `<div class="alert alert-${type} show">${msg}</div>`;
    setTimeout(()=>c.innerHTML='',3000);
}

function loadCustomersTable(q=''){
    fetch(`${api}?action=list_customers`)
        .then(r=>r.json())
        .then(data=>{
            const tbody = document.getElementById('customersBody');
            tbody.innerHTML = '';
            if (!data || !data.success) return showCustAlert('Gagal memuat customers','danger');
            let arr = data.data;
            if (q) {
                q = q.toLowerCase();
                arr = arr.filter(c => (c.name||'').toLowerCase().includes(q) || (c.email||'').toLowerCase().includes(q) || (c.phone||'').toLowerCase().includes(q));
            }
            arr.forEach(c => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="padding:10px;"><input type="checkbox" class="cust-checkbox" value="${c.id}"></td>
                    <td style="padding:10px;">${c.id}</td>
                    <td style="padding:10px;">${c.name||'-'}</td>
                    <td style="padding:10px;">${c.email||'-'}</td>
                    <td style="padding:10px;">${c.phone||'-'}</td>
                    <td style="padding:10px;">${c.local? 'Lokal':'Odoo'}</td>
                    <td style="padding:10px; text-align:center;"><button class="btn btn-danger btn-small" data-id="${c.id}">Hapus</button></td>
                `;
                tbody.appendChild(tr);

                tr.querySelector('.cust-checkbox').addEventListener('change', updateBulkBtn);

                tr.querySelector('button').addEventListener('click', function(){
                    const id = this.dataset.id;
                    if (!confirm('Hapus customer: ' + (c.name||id) + '?')) return;
                    fetch('/api.php?action=delete_customer', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id: id }) })
                        .then(r=>r.json()).then(resp=>{
                            if (resp && resp.success) { showCustAlert(resp.message || 'Berhasil','success'); loadCustomersTable(q);} else { showCustAlert('Gagal: ' + (resp.error||'Unknown'),'danger'); }
                        }).catch(err=> showCustAlert('Error: ' + err.message,'danger'));
                });
            });
        })
        .catch(err=> showCustAlert('Error: ' + err.message,'danger'));
}

function updateBulkBtn() {
    const checked = document.querySelectorAll('.cust-checkbox:checked');
    const btn = document.getElementById('btnBulkDelete');
    const selectAll = document.getElementById('selectAll');
    const all = document.querySelectorAll('.cust-checkbox');

    if (btn) {
        if (checked.length > 0) {
            btn.style.display = 'inline-block';
            btn.innerText = `üóëÔ∏è Hapus Terpilih (${checked.length})`;
        } else {
            btn.style.display = 'none';
        }
    }
    if (selectAll && all.length > 0) {
        selectAll.checked = (checked.length === all.length);
    }
}

async function handleBulkDelete() {
    const checked = document.querySelectorAll('.cust-checkbox:checked');
    const ids = Array.from(checked).map(cb => cb.value);
    if (!ids.length) return;

    if (!confirm(`Hapus ${ids.length} customer yang dipilih?`)) return;

    let success = 0;
    showCustAlert(`Sedang menghapus ${ids.length} data...`, 'info');

    for (const id of ids) {
        try {
            const resp = await fetch('/api.php?action=delete_customer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id })
            }).then(r => r.json());
            if (resp && resp.success) success++;
        } catch (e) { console.error(e); }
    }

    showCustAlert(`Selesai. ${success} berhasil dihapus.`, 'success');
    loadCustomersTable();
    if(document.getElementById('btnBulkDelete')) document.getElementById('btnBulkDelete').style.display = 'none';
    if(document.getElementById('selectAll')) document.getElementById('selectAll').checked = false;
}

window.addEventListener('DOMContentLoaded', function(){
    loadCustomersTable();
    document.getElementById('btnRefresh').addEventListener('click', ()=> loadCustomersTable());
    document.getElementById('btnSearch').addEventListener('click', ()=> loadCustomersTable(document.getElementById('searchCustomers').value));
    
    const selectAll = document.getElementById('selectAll');
    if (selectAll) {
        selectAll.addEventListener('change', function() {
            document.querySelectorAll('.cust-checkbox').forEach(cb => cb.checked = this.checked);
            updateBulkBtn();
        });
    }

    const bulkBtn = document.getElementById('btnBulkDelete');
    if (bulkBtn) bulkBtn.addEventListener('click', handleBulkDelete);
});
</script>