<?= $this->getContent() ?>

<style>
    /* Modern UI Styles - Matches Invoicing Page */
    body { background-color: #f7f9fc; }
    
    .modern-table { width: 100%; border-collapse: collapse; font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    .modern-table thead th { padding: 16px; text-align: left; color: #fff; font-size: 14px; letter-spacing: 0.3px; }
    /* Gradient for Partner - Blue/Purple theme */
    .modern-table thead { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .modern-table tbody td { padding: 16px; font-size: 15px; border-bottom: 1px solid #eef2f6; color: #2c3e50; vertical-align: middle; }
    .modern-table tbody tr { transition: background .12s ease, transform .06s ease; }
    .modern-table tbody tr:hover { background: #fbfcff; transform: translateY(-1px); box-shadow: 0 4px 14px rgba(50,50,93,0.04); }

    /* Action buttons */
    .action-btn { border: none; cursor: pointer; padding: 8px 12px; border-radius: 8px; font-size: 14px; transition: all .12s ease; display: inline-flex; align-items: center; gap: 6px; }
    .action-btn.view { color: #0954d9; background: rgba(9,84,217,0.06); }
    .action-btn.view:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(9,84,217,0.08); }
    .action-btn.create { color: #27ae60; background: rgba(39,174,96,0.1); }
    .action-btn.create:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(39,174,96,0.15); }
    .action-btn.delete { color: #c0392b; background: rgba(224,74,64,0.06); }
    .action-btn.delete:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(192,57,43,0.08); }
    
    .btn-main { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: transform 0.1s; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(118, 75, 162, 0.2); }
    .btn-main:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(118, 75, 162, 0.3); }

    .search-input { padding: 12px 16px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 15px; width: 100%; outline: none; transition: border-color 0.2s; box-shadow: 0 2px 6px rgba(0,0,0,0.02); }
    .search-input:focus { border-color: #4facfe; box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1); }

    .role-badge { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; margin-right: 4px; }
    .role-badge.cust { background: #e3f2fd; color: #1565c0; }
    .role-badge.supp { background: #e8f5e9; color: #2e7d32; }

    /* Modal styling */
    .modal { display:none; position: fixed; inset: 0; background: rgba(10,15,25,0.55); align-items: center; justify-content: center; z-index: 1200; backdrop-filter: blur(2px); }
    .modal.show { display:flex; }
    .modal-content { background: #fff; border-radius: 16px; box-shadow: 0 25px 50px rgba(0,0,0,0.2); overflow: hidden; animation: modalSlide 0.3s ease-out; border: 1px solid rgba(255,255,255,0.1); }
    @keyframes modalSlide { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    
    .modal-header { padding: 20px 25px; border-bottom: 1px solid #f0f3f6; background: #fff; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { margin: 0; font-size: 20px; color: #2d3748; font-weight: 700; }
    .modal-body { padding: 25px; max-height: 70vh; overflow-y: auto; }
    .modal-footer { padding: 20px 25px; border-top: 1px solid #f0f3f6; background: #f8fafc; text-align: right; display: flex; justify-content: flex-end; gap: 10px; }

    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568; font-size: 14px; }
    .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 15px; transition: all 0.2s; }
    .form-group input:focus, .form-group select:focus { border-color: #4facfe; outline: none; box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1); }

    .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; animation: slideDown 0.3s ease; }
    @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .alert-success { background: #def7ec; color: #03543f; border: 1px solid #bcf0da; }
    .alert-danger { background: #fde8e8; color: #9b1c1c; border: 1px solid #fbd5d5; }
    .alert-info { background: #e1effe; color: #1e429f; border: 1px solid #c3ddfd; }

    .checkbox-wrapper { display: flex; gap: 15px; align-items: center; }
    .checkbox-label { display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none; }
    .checkbox-label input { width: 18px; height: 18px; accent-color: #4facfe; cursor: pointer; }

    @media (max-width: 800px) { .modern-table td { font-size: 14px; padding: 12px; } .partner-actions { display:flex; flex-direction:column; } .modal-content { width: 95%; margin: 10px; } }
</style>

<div class="container" style="padding: 40px 20px; max-width: 1200px; margin: 0 auto;">
    <div style="margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1 style="margin: 0 0 8px 0; color: #1a202c; font-size: 28px; font-weight: 800; letter-spacing: -0.5px;">ü§ù Kelola Partners</h1>
            <p style="margin: 0; color: #718096; font-size: 15px;">Manajemen Customer dan Vendor untuk Invoice</p>
        </div>
        <div style="display: flex; gap: 10px;">
             <a href="/odoo-dashboard" class="action-btn view" style="text-decoration: none; font-weight: 600;">üìä Dashboard</a>
        </div>
    </div>

    <div style="background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); margin-bottom: 24px;">
        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 250px; position: relative;">
                <input id="searchPartners" class="search-input" placeholder="üîç Cari nama atau email...">
            </div>
            <button id="btnSearchPart" class="btn-main"><span>üîç Cari</span></button>
            <button id="btnRefreshPart" class="action-btn view">üîÑ Refresh</button>
            <button id="btnCleanupPart" class="action-btn delete" style="background: rgba(245, 158, 11, 0.1); color: #b45309;">üßπ Hapus Duplikat</button>
            <button id="openPartnerModal" class="btn-main" style="background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%); width: auto;">‚ûï Tambah Partner</button>
        </div>
    </div>

    <div id="partAlert"></div>

    <div style="background: white; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025); overflow: hidden;">
        <div style="overflow-x: auto;">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th style="width: 60px; padding-left: 24px;">ID</th>
                        <th>Nama Partner</th>
                        <th>Email</th>
                        <th>Telepon</th>
                        <th>Peran (Roles)</th>
                        <th style="text-align:center; padding-right: 24px;">Aksi</th>
                    </tr>
                </thead>
                <tbody id="partnersBody">
                    <tr><td colspan="6" style="text-align:center; padding: 40px; color: #718096;">Memuat data partners...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Invoice Modal -->
<div id="invoiceModal" class="modal">
    <div class="modal-content" style="max-width:650px; width: 90%;">
        <div class="modal-header">
            <h3>üßæ Buat Invoice / Bill</h3>
        </div>
        <div class="modal-body">
            <div id="invoiceMsg" style="margin-bottom:10px"></div>
            
            <div class="form-group">
                <label>Partner</label>
                <input id="inv_partner" readonly style="background:#f7fafc; color:#4a5568 cursor: not-allowed;">
            </div>
            
            <div style="display:flex; gap:16px; margin-top:16px;">
                <div class="form-group" style="flex:1">
                    <label>Tipe Dokumen</label>
                    <select id="inv_move_type">
                        <option value="out_invoice">Customer Invoice (Tagihan Jual)</option>
                        <option value="in_invoice">Vendor Bill (Tagihan Beli)</option>
                    </select>
                </div>
            </div>

            <div id="linkedOrderSection" style="margin-top:20px; background:#ebf8ff; border:1px dashed #4299e1; padding:16px; border-radius:12px; display:none;">
                <label style="color:#2b6cb0; font-weight:bold; display:block; margin-bottom:8px;">üì¶ Invoicing dari Order</label>
                <select id="inv_source_order" style="border-color:#63b3ed;">
                    <option value="">-- Pilih Order (Opsional) --</option>
                </select>
                <small style="color:#4a5568; display:block; margin-top:6px;">Otomatis mengisi produk & harga dari Sales/Purchase order.</small>
            </div>

            <hr style="margin:20px 0; border:0; border-top:1px solid #e2e8f0;">

            <div class="form-group">
                <label>Produk (dari Inventory Lokal)</label>
                <select id="inv_product"></select>
                <div id="inv_stock_info" style="font-size:14px; margin-top:6px; font-weight:600;"></div>
                <div id="inv_sync_info" style="font-size:13px; color:#718096; margin-top:4px;">&nbsp;</div>
                <input type="hidden" id="inv_product_name" value="">
                <div id="inv_product_desc" style="font-size:13px; color:#718096; margin-top:6px;">&nbsp;</div>
            </div>

            <div style="display:flex; gap:16px; margin-top:16px;">
                <div class="form-group" style="flex:1">
                    <label>Quantity</label>
                    <input id="inv_qty" type="number" min="0.01" step="0.01" value="1">
                </div>
                <div class="form-group" style="width:180px">
                    <label>Harga Satuan</label>
                    <input id="inv_price" type="number" step="0.01" min="0" value="0">
                </div>
            </div>
            <div style="font-size:13px; color:#718096; margin-top:-10px; margin-bottom: 20px;">Harga otomatis terisi dari Inventory. Edit jika perlu.</div>

            <div class="checkbox-wrapper">
                <label class="checkbox-label" style="font-weight: 600; color:#2d3748;">
                    <input type="checkbox" id="inv_post_now" checked> 
                    Post invoice sekarang
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button id="closeInvoiceModal" class="action-btn" style="background: transparent; color: #718096;">Batal</button>
            <button id="saveInvoiceBtn" class="btn-main">‚úÖ Buat Invoice</button>
        </div>
    </div>
</div>

<!-- Partner Modal -->
<div id="partnerModal" class="modal">
    <div class="modal-content" style="max-width:550px; width: 90%;">
        <div class="modal-header">
            <h3>‚ûï Tambah Partner Baru</h3>
        </div>
        <div class="modal-body">
            <div id="partnerMsg"></div>
            <div class="form-group">
                <label>Nama Lengkap</label>
                <input id="p_name" placeholder="Contoh: PT. Sumber Makmur">
            </div>
            <div class="form-group" style="margin-top:16px">
                <label>Email Address</label>
                <input id="p_email" placeholder="email@example.com">
            </div>
            <div class="form-group" style="margin-top:16px">
                <label>Nomor Telepon</label>
                <input id="p_phone" placeholder="08xxxxxxxxxx">
            </div>
            <div class="form-group" style="margin-top:20px">
                <label>Peran Partner</label>
                <div class="checkbox-wrapper">
                    <label class="checkbox-label"><input type="checkbox" id="p_is_customer"> Customer (Pelanggan)</label>
                    <label class="checkbox-label"><input type="checkbox" id="p_is_supplier"> Supplier (Pemasok)</label>
                </div>
            </div>
            <div class="form-group" style="margin-top:20px; background: #f7fafc; padding: 12px; border-radius: 8px;">
                <label style="margin-bottom: 8px;">Simpan Ke:</label>
                <div class="checkbox-wrapper">
                    <label class="checkbox-label"><input type="radio" name="partner_save_to" value="local" checked> üè† Lokal Database</label>
                    <label class="checkbox-label"><input type="radio" name="partner_save_to" value="odoo"> üåê Langsung Odoo</label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="closePartnerModal" class="action-btn" style="background: transparent; color: #718096;">Batal</button>
            <button id="savePartnerBtn" class="btn-main">Simpan Partner</button>
        </div>
    </div>
</div>

<script>
const API = '/api.php';
function showPartAlert(msg,type='info'){ const c=document.getElementById('partAlert'); c.innerHTML=`<div class="alert alert-${type}">${msg}</div>`; setTimeout(()=>c.innerHTML='',4000); }

function loadPartners(q=''){
    const tbody=document.getElementById('partnersBody');
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 30px;"><div style="color:#aaa">Sedang memuat data...</div></td></tr>';

    fetch(`${API}?action=list_partners`).then(r=>r.json()).then(data=>{
        tbody.innerHTML=''; 
        if(!data||!data.success) { return tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:red; padding: 20px;">Gagal memuat data partners</td></tr>'; }
        
        let arr=data.data; 
        if(q){ q=q.toLowerCase(); arr=arr.filter(s=> (s.name||'').toLowerCase().includes(q) || (s.email||'').toLowerCase().includes(q)); }
        
        if(arr.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 40px; color: #718096;">Tidak ada partner ditemukan.<br><small>Klik "Tambah Partner" untuk memulai.</small></td></tr>';
            return;
        }

        arr.forEach(s=>{
            const id = s.id;
            const r1 = (s.customer_rank && s.customer_rank>0) || s.is_customer || false;
            const r2 = (s.supplier_rank && s.supplier_rank>0) || s.is_supplier || false;
            const tr=document.createElement('tr'); 
            
            tr.innerHTML=`<td style="padding-left: 24px;"><span style="background:#edf2f7; padding:4px 8px; border-radius:4px; font-family:monospace; font-size:13px;">#${id}</span></td>
                          <td style="font-weight:600; color:#2d3748;">${s.name||'-'}</td>
                          <td style="color:#4a5568;">${s.email||'-'}</td>
                          <td style="color:#4a5568;">${s.phone||'-'}</td>
                          <td>
                              <div class="checkbox-wrapper" style="gap:12px;">
                                  <label class="checkbox-label" title="Set Customer"><input type="checkbox" data-id="${id}" data-role="customer" ${r1? 'checked':''}> <span style="font-size:13px">Cust</span></label>
                                  <label class="checkbox-label" title="Set Supplier"><input type="checkbox" data-id="${id}" data-role="supplier" ${r2? 'checked':''}> <span style="font-size:13px">Supp</span></label>
                              </div>
                          </td>
                          <td style="text-align:center; padding-right: 24px;">
                              <button class="action-btn view btn-view-inv" data-id="${id}" title="Lihat Invoice">üìÑ Lihat Inv.</button>
                              <button class="action-btn create btn-create-inv" data-id="${id}" style="margin-left:6px" title="Buat Invoice Baru">‚ûï Buat</button>
                              <button class="action-btn delete btn-delete" data-id="${id}" style="margin-left:6px" title="Hapus Partner">üóëÔ∏è</button>
                          </td>`;
            tbody.appendChild(tr);

            // attach handlers
            tr.querySelectorAll('input[type="checkbox"]').forEach(ch => {
                ch.addEventListener('change', function(){
                    const role = this.dataset.role;
                    // read other checkbox state too
                    const row = this.closest('tr');
                    const cust = row.querySelector('input[data-role="customer"]').checked ? 1 : 0;
                    const supp = row.querySelector('input[data-role="supplier"]').checked ? 1 : 0;
                    fetch('/api.php?action=update_partner_roles',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:String(id), is_customer:cust, is_supplier:supp})}).then(r=>r.json()).then(resp=>{ if(resp && resp.success){ showPartAlert('Roles diupdate','success'); } else showPartAlert('Gagal update roles','danger'); }).catch(err=>showPartAlert('Error updating roles','danger'));
                });
            });

            // View invoices handler
            const viewBtn = tr.querySelector('.btn-view-inv');
            if (viewBtn) viewBtn.addEventListener('click', function(){
                try {
                    const pid = this.dataset.id;
                    if (/^\d+$/.test(pid)) {
                        window.location = '/odoo-invoicing?partner_id=' + pid;
                    } else {
                        showPartAlert('Partner lokal belum ada di Odoo. Gunakan tombol Buat Invoice untuk sinkronisasi.', 'warning');
                    }
                } catch (e) {
                    console.error('Error in viewBtn handler:', e); showPartAlert('Error internal', 'danger');
                }
            });

            // Create invoice handler (opens inline modal)
            const createBtn = tr.querySelector('.btn-create-inv');
            if (createBtn) createBtn.addEventListener('click', function(){
                try {
                    console.debug('create invoice clicked for partner:', s);
                    const pid = this.dataset.id;
                    const partnerName = s.name || 'Unknown';
                    
                    if (/^\d+$/.test(pid)) {
                        document.getElementById('inv_partner').value = partnerName + ' (ID: ' + pid + ')';
                        document.getElementById('inv_partner').dataset.partnerId = pid;
                        
                        // Default move type based on flags
                        const isCust = (s.customer_rank && s.customer_rank>0) || s.is_customer;
                        const isSupp = (s.supplier_rank && s.supplier_rank>0) || s.is_supplier;
                        document.getElementById('inv_move_type').value = isSupp && !isCust ? 'in_invoice' : 'out_invoice';

                        // Reset modal
                        document.getElementById('inv_qty').value = 1;
                        document.getElementById('inv_price').value = 0;
                        document.getElementById('inv_source_order').innerHTML = '<option value="">-- Meluncurkan pencarian order... --</option>';
                        document.getElementById('linkedOrderSection').style.display = 'none';

                        // Load products from local Inventory API
                        fetch('/inventory-api/list?limit=1000') // increased limit
                            .then(r=>r.json())
                            .then(resp=>{
                                const sel = document.getElementById('inv_product'); 
                                sel.innerHTML='';
                                if (resp && resp.success) {
                                    sel.innerHTML = '<option value="">-- Pilih Produk --</option>';
                                    resp.data.forEach(p=>{
                                        const opt = document.createElement('option');
                                        opt.value = p.id;
                                        opt.dataset.odoo = p.odoo_id || '';
                                        opt.dataset.name = p.name || '';
                                        opt.dataset.price = p.selling_price || 0;
                                        opt.dataset.qty = p.quantity || 0;
                                        const stock = parseFloat(p.quantity || 0);
                                        const priceText = (p.selling_price || 0).toLocaleString ? (p.selling_price||0).toLocaleString('id-ID') : p.selling_price;
                                        opt.textContent = `${p.name} (Stok: ${stock}) - Rp ${priceText}`;
                                        sel.appendChild(opt);
                                    });
                                    
                                    // Add change listener
                                    sel.onchange = function() {
                                        const opt = this.options[this.selectedIndex];
                                        if (opt && opt.value) {
                                            document.getElementById('inv_price').value = opt.dataset.price;
                                            const qty = parseFloat(opt.dataset.qty);
                                            const stockDiv = document.getElementById('inv_stock_info');
                                            if (qty > 0) {
                                                stockDiv.style.color = '#27ae60';
                                                stockDiv.textContent = `‚úÖ Stok Tersedia: ${qty} Unit`;
                                            } else {
                                                stockDiv.style.color = '#e74c3c';
                                                stockDiv.textContent = `‚ö†Ô∏è Stok Habis (Qty: ${qty})`;
                                            }

                                            // Sync info
                                            const syncDiv = document.getElementById('inv_sync_info');
                                            if (opt.dataset.odoo && String(opt.dataset.odoo).length>0) {
                                                syncDiv.style.color = '#27ae60';
                                                syncDiv.textContent = '‚úÖ Tersinkron ke Odoo (ID: ' + opt.dataset.odoo + ')';
                                            } else {
                                                syncDiv.style.color = '#d69e2e';
                                                syncDiv.textContent = '‚ö†Ô∏è Belum disinkron ke Odoo ‚Äî akan diproses sebagai one-time product.';
                                            }
                                        } else {
                                            document.getElementById('inv_price').value = 0;
                                            document.getElementById('inv_stock_info').textContent = '';
                                            document.getElementById('inv_sync_info').textContent = '';
                                        }
                                    };
                                } else {
                                    sel.innerHTML = '<option value="">Gagal memuat produk</option>';
                                }
                            })
                            .catch(err => {
                                console.error('Error loading inventory products:', err);
                                document.getElementById('inv_product').innerHTML = '<option value="">Error memuat produk</option>';
                            });

                        // Fetch pending orders
                        fetch(`/api.php?action=get_partner_orders&partner_id=${pid}`)
                            .then(r=>r.json())
                            .then(resp=>{
                                if (resp && resp.success && (resp.data.sales.length > 0 || resp.data.purchases.length > 0)) {
                                    const orderSel = document.getElementById('inv_source_order');
                                    orderSel.innerHTML = '<option value="">-- Pilih Order Terkonfirmasi (Opsional) --</option>';
                                    
                                    if (resp.data.sales.length > 0) {
                                        const optGroup = document.createElement('optgroup'); optGroup.label = "Sales Orders (SO)";
                                        resp.data.sales.forEach(o => {
                                            const opt = document.createElement('option');
                                            opt.value = o.id; opt.dataset.type = 'sale';
                                            opt.textContent = `${o.name} - Rp ${(o.amount_total||0).toLocaleString('id-ID')}`;
                                            optGroup.appendChild(opt);
                                        });
                                        orderSel.appendChild(optGroup);
                                    }
                                    
                                    if (resp.data.purchases.length > 0) {
                                        const optGroup = document.createElement('optgroup'); optGroup.label = "Purchase Orders (PO)";
                                        resp.data.purchases.forEach(o => {
                                            const opt = document.createElement('option');
                                            opt.value = o.id; opt.dataset.type = 'purchase';
                                            opt.textContent = `${o.name} - Rp ${(o.amount_total||0).toLocaleString('id-ID')}`;
                                            optGroup.appendChild(opt);
                                        });
                                        orderSel.appendChild(optGroup);
                                    }
                                    document.getElementById('linkedOrderSection').style.display = 'block';
                                }
                            })
                            .catch(err => console.error('Error fetching partner orders:', err));
                        
                        document.getElementById('invoiceModal').classList.add('show');
                        return;
                    }

                    // else local partner
                    showPartAlert('Partner lokal harus disinkron ke Odoo dulu.', 'info');
                    // Automatically create in Odoo on click if not exists?? - Let's keep logic simple for now, prompt user logic is complex.
                    // Reuse existing logic:
                     fetch('/api.php?action=create_partner',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:s.name,email:s.email,phone:s.phone,save_to:'odoo'})}).then(r=>r.json()).then(resp=>{
                        if (resp && resp.partner_id) {
                            showPartAlert('Partner berhasil dibuat di Odoo! Silakan klik Buat Invoice lagi.', 'success');
                            loadPartners(q); // reload to get ID
                        } else showPartAlert('Gagal membuat partner di Odoo', 'danger');
                    });
                } catch (ex) {
                    console.error('Exception in createBtn handler:', ex);
                    showPartAlert('Error internal popup', 'danger');
                }
            });

            // Delete handler
            const delBtn = tr.querySelector('button.btn-delete');
            if (delBtn) delBtn.addEventListener('click', function(){ 
                const id=this.dataset.id; 
                if(!confirm('Hapus partner '+(s.name||id)+'?')) return; 
                fetch('/api.php?action=delete_partner',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:id})})
                .then(r=>r.json())
                .then(resp=>{ 
                    if(resp && resp.success){ showPartAlert(resp.message||'Dihapus','success'); loadPartners(q);} 
                    else showPartAlert('Gagal: '+(resp.error||'Unknown'),'danger'); 
                }).catch(err=>showPartAlert('Error: '+err.message,'danger')); 
            });
        });
    }).catch(err=>showPartAlert('Error: '+err.message,'danger'));
}

window.addEventListener('DOMContentLoaded', function(){ 
    loadPartners(); 
    
    document.getElementById('btnRefreshPart').addEventListener('click', ()=>loadPartners()); 
    // Trigger search on enter key as well
    document.getElementById('searchPartners').addEventListener('keyup', (e)=>{ if(e.key === 'Enter') loadPartners(e.target.value) });
    document.getElementById('btnSearchPart').addEventListener('click', ()=>loadPartners(document.getElementById('searchPartners').value));

    // Cleanup Duplicates handler
    const btnCleanup = document.getElementById('btnCleanupPart');
    if (btnCleanup) {
        btnCleanup.addEventListener('click', function() {
            if(!confirm('Apakah Anda yakin ingin menghapus partner duplikat? Versi lama akan dihapus.')) return;
            const btn = this;
            const originalText = btn.textContent;
            btn.disabled = true; btn.textContent = 'üßπ Sedang...';
            fetch('/api.php?action=cleanup_duplicate_partners').then(res => res.json()).then(data => {
                if (data.success) { alert(`Berhasil!\nDihapus: ${data.deleted_count}`); loadPartners(); } 
                else { alert('Info: ' + (data.error || 'Unknown')); }
            }).catch(err => { console.error(err); alert('Error network'); }).finally(() => { btn.disabled = false; btn.textContent = originalText; });
        });
    }
    document.getElementById('openPartnerModal').addEventListener('click', ()=>{ document.getElementById('partnerModal').classList.add('show'); });
    document.getElementById('closePartnerModal').addEventListener('click', ()=>{ document.getElementById('partnerModal').classList.remove('show'); });
    
    document.getElementById('savePartnerBtn').addEventListener('click', ()=>{
        const name=document.getElementById('p_name').value||''; const email=document.getElementById('p_email').value||''; const phone=document.getElementById('p_phone').value||'';
        const is_customer=document.getElementById('p_is_customer').checked?1:0; const is_supplier=document.getElementById('p_is_supplier').checked?1:0; const saveTo=(document.querySelector('input[name="partner_save_to"]:checked')||{}).value||'local';
        if(!name.trim()){ document.getElementById('partnerMsg').innerHTML='<div class="alert alert-danger">Nama wajib diisi</div>'; return; }
        fetch('/api.php?action=create_partner',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:name.trim(),email:email.trim(),phone:phone.trim(),is_customer:is_customer,is_supplier:is_supplier,save_to:saveTo})}).then(r=>r.json()).then(data=>{ if(data && data.success){ showPartAlert('Partner dibuat','success'); loadPartners(); document.getElementById('partnerModal').classList.remove('show'); } else { document.getElementById('partnerMsg').innerHTML='<div class="alert alert-danger">Gagal: '+(data.error||'Unknown')+'</div>'; } }).catch(err=>{ document.getElementById('partnerMsg').innerHTML='<div class="alert alert-danger">Error: '+err.message+'</div>'; });
    });

    // Invoice modal interactions
    document.getElementById('closeInvoiceModal').addEventListener('click', ()=>{ document.getElementById('invoiceModal').classList.remove('show'); });
    
    // Auto-update price, stock and sync info when product selected
    document.getElementById('inv_product').addEventListener('change', function(){
        const opt = this.options[this.selectedIndex];
        const qtyField = document.getElementById('inv_qty');
        const stockDiv = document.getElementById('inv_stock_info');
        const syncDiv = document.getElementById('inv_sync_info');

        if (opt && opt.dataset) {
            document.getElementById('inv_price').value = opt.dataset.price || 0;
            const qty = parseFloat(opt.dataset.qty || 0);
            if (qty > 0) { stockDiv.style.color = '#27ae60'; stockDiv.textContent = `‚úÖ Stok: ${qty}`; }
            else { stockDiv.style.color = '#e74c3c'; stockDiv.textContent = `‚ö†Ô∏è Stok Habis (${qty})`; }

            // If user already entered qty, verify against stock and show visual warning
            const userQty = parseFloat(qtyField.value || 0);
            if (!isNaN(userQty) && userQty > qty) {
                qtyField.style.borderColor = '#e74c3c';
                stockDiv.style.color = '#e74c3c';
                stockDiv.textContent = `‚ö†Ô∏è Jumlah (${userQty}) melebihi stok tersedia (${qty})`;
            } else {
                qtyField.style.borderColor = '';
            }

            if (opt.dataset.odoo && String(opt.dataset.odoo).length>0) {
                syncDiv.style.color = '#27ae60'; syncDiv.textContent = '‚úÖ Sync Odoo';
                document.getElementById('inv_product_desc').textContent = ''; document.getElementById('inv_product_name').value = '';
            } else {
                syncDiv.style.color = '#d69e2e'; syncDiv.textContent = '‚ö†Ô∏è Unsynced Product';
                document.getElementById('inv_product_desc').textContent = ''; document.getElementById('inv_product_name').value = '';
            }
        } else {
            document.getElementById('inv_price').value = 0;
            stockDiv.textContent = '';
            syncDiv.textContent = '';
            document.getElementById('inv_product_desc').textContent = '';
            document.getElementById('inv_product_name').value = '';
            qtyField.style.borderColor = '';
        }
    });

    // Warn when quantity input changes relative to selected product stock
    document.getElementById('inv_qty').addEventListener('input', function(){
        const val = parseFloat(this.value || 0);
        const sel = document.getElementById('inv_product');
        const opt = sel.options[sel.selectedIndex];
        const stockDiv = document.getElementById('inv_stock_info');
        if (opt && opt.dataset && opt.dataset.qty !== undefined) {
            const stock = parseFloat(opt.dataset.qty || 0);
            if (!isNaN(val) && val > stock) {
                this.style.borderColor = '#e74c3c';
                stockDiv.style.color = '#e74c3c';
                stockDiv.textContent = `‚ö†Ô∏è Jumlah (${val}) melebihi stok tersedia (${stock})`;
            } else {
                this.style.borderColor = '';
                // Reset stockDiv to normal message
                if (stock > 0) { stockDiv.style.color = '#27ae60'; stockDiv.textContent = `‚úÖ Stok Tersedia: ${stock} Unit`; }
                else { stockDiv.style.color = '#e74c3c'; stockDiv.textContent = `‚ö†Ô∏è Stok Habis (Qty: ${stock})`; }
            }
        }
    });

    // Auto-fill from Order
    document.getElementById('inv_source_order').addEventListener('change', function(){
        const orderId = this.value; if (!orderId) return;
        const opt = this.options[this.selectedIndex];
        const type = opt.dataset.type;
        document.getElementById('inv_move_type').value = (type === 'sale') ? 'out_invoice' : 'in_invoice';
        
        fetch(`/api.php?action=get_order_details&id=${orderId}&type=${type}`).then(r=>r.json()).then(resp=>{
            if (resp && resp.success && resp.data.length > 0) {
                const line = resp.data[0]; 
                if (line.product_id) {
                    const sel = document.getElementById('inv_product');
                    let matched = false;
                    Array.from(sel.options).forEach(opt => {
                        if (opt.dataset && opt.dataset.odoo && String(opt.dataset.odoo) === String(line.product_id[0])) { sel.value = opt.value; matched = true; }
                    });
                    if (!matched) sel.value = '';
                }
                document.getElementById('inv_qty').value = line.product_uom_qty || 1;
                document.getElementById('inv_price').value = line.price_unit || 0;
                if (!document.getElementById('inv_product').value) {
                    document.getElementById('inv_product_name').value = line.name || '';
                }
                // Trigger change
                const ev = new Event('change'); document.getElementById('inv_product').dispatchEvent(ev);
            }
        });
    });

    document.getElementById('saveInvoiceBtn').addEventListener('click', ()=>{
        try {
            const partnerId = document.getElementById('inv_partner').dataset.partnerId;
            const moveType = document.getElementById('inv_move_type').value;
            const productIdRaw = document.getElementById('inv_product').value;
            const qty = parseFloat(document.getElementById('inv_qty').value);
            const price = parseFloat(document.getElementById('inv_price').value);
            const orderId = document.getElementById('inv_source_order').value;
            
            const prodOpt = document.getElementById('inv_product').selectedOptions ? document.getElementById('inv_product').selectedOptions[0] : null;
            const productName = (prodOpt && prodOpt.dataset && prodOpt.dataset.name) ? prodOpt.dataset.name : (document.getElementById('inv_product_name').value || (productIdRaw ? 'Product ID '+productIdRaw : 'Product'));
            let productId = null;
            if (prodOpt && prodOpt.dataset && prodOpt.dataset.odoo) productId = parseInt(prodOpt.dataset.odoo);

            if (!partnerId) { alert('Partner tidak valid', 'danger'); return; }
            if (!productId && !productName && !orderId) { alert('Pilih produk', 'danger'); return; }

            // Stock validation: if product comes from inventory and qty > stock, warn user
            if (prodOpt && prodOpt.dataset && prodOpt.dataset.qty !== undefined) {
                const stock = parseFloat(prodOpt.dataset.qty || 0);
                if (!isNaN(stock) && qty > stock) {
                    document.getElementById('inv_qty').style.borderColor = '#e74c3c';
                    showPartAlert(`Quantity (${qty}) melebihi stok tersedia (${stock}).`, 'danger');
                    if (!confirm('Quantity melebihi stok tersedia. Lanjutkan pembuatan invoice?')) {
                        document.getElementById('inv_qty').focus();
                        return;
                    }
                }
            }

            const postNow = document.getElementById('inv_post_now').checked ? 1 : 0;
            const payload = { partner_id: partnerId, move_type: moveType, product_id: productId, product_name: productName, quantity: qty, price: price, order_id: orderId, post_now: postNow };

            showPartAlert('Memproses...', 'info');
            fetch('/api.php?action=create_invoice', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            }).then(r=>r.json()).then(resp=>{
                if (resp && resp.success) {
                    window.location.href = '/odoo-invoicing/view/' + resp.invoice_id; // Redirect logic
                } else {
                    showPartAlert('Gagal: ' + (resp.error || 'Unknown error'), 'danger');
                }
            }).catch(err => { showPartAlert('Error network', 'danger'); });
        } catch (ex) { showPartAlert('Internal Error', 'danger'); }
    });
});
</script>