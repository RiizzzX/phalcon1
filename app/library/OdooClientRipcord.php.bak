<?php

namespace App\Library;

/**
 * Simple Odoo Client using basic XML-RPC
 */
class OdooClient
{
    private $url;
    private $db;
    private $username;
    private $password;
    private $uid;

    public function __construct()
    {
        $this->url = 'http://odoo:8069';
        $this->db = 'coba_odoo';
        $this->username = 'farizlahya@gmail.com';
        $this->password = 'guwosari6b';
    }

    public function authenticate()
    {
        if ($this->uid) {
            return $this->uid;
        }

        $client = new \Ripcord\Client($this->url . '/xmlrpc/2/common');
        $this->uid = $client->authenticate($this->db, $this->username, $this->password, []);
        
        return $this->uid;
    }

    private function execute($model, $method, $args = [])
    {
        if (!$this->uid) {
            $this->authenticate();
        }

        $client = new \Ripcord\Client($this->url . '/xmlrpc/2/object');
        return $client->execute_kw($this->db, $this->uid, $this->password, $model, $method, $args);
    }

    public function executePublic($model, $method, $args = [])
    {
        return $this->execute($model, $method, $args);
    }

    public function getEquipments($filters = [])
    {
        return $this->execute('equipment.rental', 'search_read', [
            [$filters],
            ['name', 'code', 'category', 'daily_rate', 'status', 'condition']
        ]);
    }

    public function getEquipment($id)
    {
        $result = $this->execute('equipment.rental', 'read', [
            [$id],
            ['name', 'code', 'category', 'daily_rate', 'status', 'condition', 'description']
        ]);
        
        return $result ? $result[0] : null;
    }

    public function createEquipment($data)
    {
        return $this->execute('equipment.rental', 'create', [[$data]]);
    }

    public function updateEquipment($id, $data)
    {
        return $this->execute('equipment.rental', 'write', [[$id], $data]);
    }

    public function getRentals($filters = [])
    {
        return $this->execute('rental.transaction', 'search_read', [
            [$filters],
            ['name', 'customer_name', 'customer_phone', 'equipment_id', 'rental_date', 'return_date', 'total_amount', 'state']
        ]);
    }

    public function createRental($data)
    {
        return $this->execute('rental.transaction', 'create', [[$data]]);
    }

    public function confirmRental($id)
    {
        return $this->execute('rental.transaction', 'action_confirm', [[$id]]);
    }

    public function returnRental($id)
    {
        return $this->execute('rental.transaction', 'action_return', [[$id]]);
    }

    public function getAvailableEquipments()
    {
        return $this->getEquipments([['status', '=', 'available']]);
    }
}
